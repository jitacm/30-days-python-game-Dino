<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dino Run</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Press Start 2P', monospace;
      background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
      overflow: hidden;
    }

    canvas {
      image-rendering: pixelated;
      border-radius: 0.5rem;
      background-color: #fff;
    }

    #startScreen,
    #gameOver {
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .btn {
      padding: 12px 24px;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: scale(1.05);
    }
  </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen text-gray-800 relative">

  <h1 class="text-4xl md:text-5xl mb-4 text-green-700 drop-shadow-lg animate-bounce z-0">ğŸ¦– Dino Run</h1>
  <div class="mb-4 text-lg">
    High Score: <span id="highScoreDisplay">0</span>
  </div>
  <canvas id="gameCanvas" class="shadow-2xl border-8 border-green-500"></canvas>

  <!-- Start Screen -->
  <div id="startScreen"
    class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center text-center z-10">
    <h2 class="text-3xl md:text-4xl text-white mb-6">Welcome to Dino Run</h2>
    <p class="text-white mb-4">Press SPACE or Tap to Jump</p>
    <button id="startBtn" class="btn bg-green-500 text-white hover:bg-green-600 text-lg">ğŸ® Start Game</button>
  </div>

  <!-- Game Over Screen -->
  <div id="gameOver" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-10">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl text-center">
      <h2 class="text-2xl md:text-3xl text-red-600 font-bold mb-4">ğŸ’¥ Game Over!</h2>
      <p class="text-lg md:text-xl text-gray-700 mb-4">Final Score: <span id="finalScore"
          class="font-bold text-black"></span></p>
      <button id="restartBtn" class="btn bg-green-600 text-white hover:bg-green-700 text-lg">ğŸ” Restart</button>
    </div>
  </div>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 400;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    const GRAVITY = 0.6;
    const GROUND_HEIGHT = 50;

    let dino = {
      x: 50,
      y: GAME_HEIGHT - GROUND_HEIGHT - 47,
      width: 44,
      height: 47,
      velocityY: 0,
      isJumping: false,
      frame: 0
    };
    let cacti = [];
    let clouds = [];
    let groundX = 0;
    let spawnTimer = 0;
    let score = 0;
    let isRunning = false;
    let animationId = null;

    const images = {};
    let assetsLoaded = false;
    let dinoFrameWidth = 44;
    let dinoFrameHeight = 47;
    let dinoFrameCount = 1;

    // High score
    let highScore = 0;

    // Load high score from backend
    async function loadHighScore() {
      try {
        const res = await fetch("/get_score");
        const data = await res.json();
        highScore = data.highScore || 0;
        document.getElementById("highScoreDisplay").textContent = highScore;
      } catch (err) {
        console.error("Failed to load high score:", err);
      }
    }

    // Save high score to backend
    async function saveHighScore(score) {
      try {
        await fetch("/save_score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ score })
        });
      } catch (err) {
        console.error("Failed to save high score:", err);
      }
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = src;
        img.onload = () => resolve(img);
        img.onerror = () => reject(`Failed to load image: ${src}`);
      });
    }

    async function loadAssets() {
      try {
        images.dino = await loadImage("static/assets/Adobe Express - file.png");
        images.cactus = await loadImage("static/assets/cactus-small.png");
        images.cloud = await loadImage("static/assets/cloud.png");
        images.ground = await loadImage("static/assets/ground.png");

        // Detect sprite frames
        dinoFrameHeight = images.dino.height;
        if (images.dino.width > dinoFrameHeight) {
          dinoFrameCount = 2; // adjust if you have more
          dinoFrameWidth = images.dino.width / dinoFrameCount;
        } else {
          dinoFrameWidth = images.dino.width;
          dinoFrameCount = 1;
        }

        dino.width = dinoFrameWidth;
        dino.height = dinoFrameHeight;

        assetsLoaded = true;
      } catch (err) {
        console.error(err);
      }
    }

    function drawDino() {
      const frameX = Math.floor(dino.frame) * dinoFrameWidth;
      ctx.drawImage(images.dino, frameX, 0, dinoFrameWidth, dinoFrameHeight, dino.x, dino.y, dino.width, dino.height);
    }

    function gameLoop() {
      if (!isRunning) return;
      ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

      // Jump physics
      dino.velocityY += GRAVITY;
      dino.y += dino.velocityY;
      if (dino.y >= GAME_HEIGHT - GROUND_HEIGHT - dino.height) {
        dino.y = GAME_HEIGHT - GROUND_HEIGHT - dino.height;
        dino.isJumping = false;
        dino.velocityY = 0;
      }

      // Dino animation
      if (!dino.isJumping && dinoFrameCount > 1) {
        dino.frame = (dino.frame + 0.15) % dinoFrameCount;
      } else {
        dino.frame = 0;
      }

      // Clouds
      if (Math.random() < 0.01) clouds.push({ x: GAME_WIDTH, y: Math.random() * GAME_HEIGHT / 2, speed: 0.5 + Math.random() });
      clouds.forEach(cloud => cloud.x -= cloud.speed);
      clouds = clouds.filter(cloud => cloud.x + 90 > 0);
      clouds.forEach(cloud => ctx.drawImage(images.cloud, cloud.x, cloud.y, 90, 30));

      const groundY = GAME_HEIGHT - GROUND_HEIGHT;

      // Ground
      groundX = (groundX - 5 + GAME_WIDTH) % GAME_WIDTH;
      const groundOffset = 30;
      ctx.drawImage(images.ground, groundX, GAME_HEIGHT - GROUND_HEIGHT - groundOffset, GAME_WIDTH, GROUND_HEIGHT);
      ctx.drawImage(images.ground, groundX - GAME_WIDTH, GAME_HEIGHT - GROUND_HEIGHT - groundOffset, GAME_WIDTH, GROUND_HEIGHT);

      // Cactus
      spawnTimer++;
      if (spawnTimer > 90) {
        cacti.push({ x: GAME_WIDTH, y: groundY - 40, width: 30, height: 40 });
        spawnTimer = 0;
      }
      cacti.forEach(cactus => cactus.x -= 5);
      cacti = cacti.filter(cactus => cactus.x + cactus.width > 0);
      cacti.forEach(cactus => ctx.drawImage(images.cactus, cactus.x, cactus.y, cactus.width, cactus.height));

      // Collision detection
      let gameOver = false;
      cacti.forEach(cactus => {
        if (dino.x < cactus.x + cactus.width && dino.x + dino.width > cactus.x && dino.y < cactus.y + cactus.height && dino.y + dino.height > cactus.y) {
          gameOver = true;
        }
      });

      if (gameOver) {
        isRunning = false;
        document.getElementById("gameOver").classList.remove("hidden");
        document.getElementById("finalScore").textContent = Math.floor(score);

        // Update high score
        if (score > highScore) {
          highScore = Math.floor(score);
          document.getElementById("highScoreDisplay").textContent = highScore;
          saveHighScore(highScore);
        }
      }

      drawDino();

      // Score
      score += 0.1;
      ctx.fillStyle = "#222";
      ctx.font = "14px 'Press Start 2P'";
      ctx.fillText("SCORE: " + Math.floor(score), 10, 25);

      animationId = requestAnimationFrame(gameLoop);
    }

    // Start / Restart / Jump functions remain the same
    async function startGame() {
      if (!assetsLoaded) await loadAssets();
      document.getElementById("startScreen")?.classList.add("hidden");
      document.getElementById("gameOver")?.classList.add("hidden");
      isRunning = true;
      score = 0;
      dino.y = GAME_HEIGHT - GROUND_HEIGHT - dino.height;
      dino.velocityY = 0;
      cacti = [];
      clouds = [];
      spawnTimer = 0;
      cancelAnimationFrame(animationId);
      gameLoop();
    }

    function restartGame() {
      startGame();
    }

    function jump() {
      if (!dino.isJumping && isRunning) {
        dino.isJumping = true;
        dino.velocityY = -12;
      }
    }

    // Controls
    window.addEventListener("keydown", e => { if (e.code === "Space") jump(); });
    window.addEventListener("touchstart", jump);

    // Buttons
    document.getElementById("startBtn")?.addEventListener("click", startGame);
    document.getElementById("restartBtn")?.addEventListener("click", restartGame);

    // Preload
    loadAssets();
    loadHighScore();
  </script>



</body>

</html>